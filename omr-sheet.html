<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OMR Sheet - Yuva Gyan Mahotsav 2026</title>

<style>
* { box-sizing: border-box; -webkit-print-color-adjust: exact; }

body {
    margin: 0;
    padding: 0;
    background-color: #f0f0f0;
    font-family: 'Segoe UI', Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* --- Control Panel Styling (Screen Only) --- */
#control-panel {
    width: 100%;
    background-color: #2c3e50;
    color: white;
    padding: 15px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    margin-bottom: 20px;
    z-index: 9999;
}
#control-panel input {
    padding: 8px;
    border-radius: 4px;
    border: none;
    margin: 0 5px;
    width: 80px;
    text-align: center;
}
#control-panel button {
    padding: 8px 15px;
    margin: 0 5px;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
}
.btn-gen { background-color: #e67e22; }
.btn-gen:hover { background-color: #d35400; }
.btn-excel { background-color: #27ae60; }
.btn-excel:hover { background-color: #219150; }
.btn-reset { background-color: #c0392b; }
.btn-reset:hover { background-color: #a93226; }

.panel-group { display: inline-block; margin: 0 10px; }
.status-bar { margin-top: 8px; font-size: 0.85em; color: #bdc3c7; }

/* --- Original Page Styling --- */
.page {
    width: 210mm;
    height: 297mm;
    background-color: #ffffff;
    padding: 5mm 8mm;
    display: flex;
    flex-direction: column;
    border: 1px solid #000;
    position: relative;
    z-index: 0;
    overflow: hidden;
    margin-bottom: 20px; /* Space between sheets on screen */
}

/* Background Watermark */
.page::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgZD10cm2RDqNWP2IPsT01lVeki4FNEoS3Dj9YaXI2bygfF1RwxD4HAtno-APUK-k-CPD_Yj1mtBAQqNvsPjeCHPZnYQdotMvLfkHwrXkVqf2-_83-fYJLyaAfNVlrsQ5C764cv_McWsDdQKxscplGOmElge2u6EXlMNocUkZhyiPG2Cw/s1600/TYS-White.png');
    background-position: center center;
    background-repeat: no-repeat;
    background-size: 60%;
    opacity: 0.10;
    z-index: -1;
}

@media print {
    body { background: none; display: block; }
    #control-panel { display: none !important; }
    .page { 
        border: 1px solid #000; 
        margin: 0; 
        box-shadow: none; 
        page-break-after: always; /* Forces new page for each OMR */
    }
    @page { size: A4; margin: 0; }
}

/* Machine readable marks */
.timing-mark { position: absolute; background: #000; }
.tm-top, .tm-bottom { width: 10px; height: 4px; }
.tm-left, .tm-right { width: 4px; height: 10px; }

/* Header */
.header {
    text-align: center;
    border: 2px solid #FF9933;
    background-color: #fffaf5;
    padding: 4px;
    margin-bottom: 8px;
    border-radius: 4px;
    position: relative;
}
.header h1 { margin: 0; font-size: 16pt; color: #e67e22; }
.header h2 { margin: 2px 0 0; font-size: 11pt; color: #333; }

/* QR Code Style */
.qr-code-img {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    width: 45px;
    height: 45px;
    border: 1px solid #ddd;
    background: #fff;
}

/* Info Section */
.info-section {
    display: grid;
    grid-template-columns: 2.1fr 1fr;
    gap: 10px;
    margin-bottom: 2px;
}

.field {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
    font-size: 8.5pt;
    font-weight: bold;
    white-space: nowrap;
}

/* Box Styles */
.box-wrap { display: flex; margin-left: 5px; }

.box {
    width: 17px;
    height: 21px;
    border: 1px solid #000;
    margin-right: -1px;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: #555;
}

/* Secret Key Center */
.secret-key {
    margin: 4px 0;
    display: flex;
    justify-content: center;
}
.secret-key .field { margin-bottom: 0; }

/* Instructions Bar */
.instructions-bar {
    border: 1px solid #333;
    background-color: #eee;
    padding: 4px 10px;
    margin-bottom: 5px;
    font-size: 7.5pt;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.inst-list {
    margin: 0; padding: 0; list-style: none;
    display: flex; gap: 15px; font-weight: bold;
}
.inst-title {
    background: #333; color: #fff; padding: 2px 6px;
    border-radius: 3px; margin-right: 10px; font-weight: bold;
}
.visual-guide { display: flex; align-items: center; gap: 6px; font-weight: bold; }
.bubble-guide {
    width: 11px; height: 11px;
    border: 1px solid #000; border-radius: 50%; display: inline-block;
}

/* OMR Grid - Tight fit */
.omr-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    column-gap: 25px;
    flex-grow: 1;
    border-top: 1px solid #ccc;
    padding-top: 5px;
}

.q-column { display: flex; flex-direction: column; }

.q-row {
    display: flex;
    align-items: center;
    height: 19.5px;
    border-bottom: 1px solid #eee;
}

.q-num {
    width: 24px;
    font-size: 8.5pt;
    font-weight: bold;
    color: #e67e22;
}

.options {
    display: flex;
    flex-grow: 1;
    justify-content: space-between;
    padding-right: 2px;
}

.opt-item {
    display: flex;
    align-items: center;
    gap: 3px;
    font-size: 7.5pt;
    font-weight: bold;
}

.bubble {
    width: 13.5px;
    height: 13.5px;
    border: 1.1pt solid #000;
    border-radius: 50%;
}

/* Subject row */
.subject-row {
    text-align: center;
    font-size: 8pt;
    font-weight: bold;
    padding: 2px 0;
    border-top: 1px dashed #999;
    border-bottom: 1px dashed #999;
    background: #fff;
    margin-bottom: 1px;
}

/* Official Use */
.official-use {
    margin-top: 8px;
    border: 2px solid #138808;
    border-radius: 4px;
    padding: 6px;
    background-color: #f4faf4;
}

.official-header {
    text-align: center;
    font-weight: bold;
    color: #138808;
    font-size: 9pt;
    margin-bottom: 4px;
    border-bottom: 1px solid #138808;
}

.score-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
}

.score-label { font-size: 7.5pt; font-weight: bold; }
.score-value { height: 22px; border: 1px solid #333; background: #fff; }
.total-score { background: #e8f5e9; border: 1.5px solid #138808; }

/* Footer */
.footer {
    margin-top: 10px;
    display: grid;
    grid-template-columns: 1fr 100px 1fr;
    gap: 15px;
}

.sign-box { height: 45px; border: 1.2pt solid #000; }
.box-label { font-size: 8pt; font-weight: bold; text-align: center; margin-top: 2px;}
.stamp-box {
    border: 2px dashed #FF9933;
    display: flex; align-items: center; justify-content: center;
    font-size: 7pt; color: #FF9933;
}
</style>
</head>

<body>

<div id="control-panel">
    <div class="panel-group">
        <label>Total Sheets:</label>
        <input type="number" id="sheetCount" value="1" min="1" max="500">
    </div>
    <div class="panel-group">
        <button class="btn-gen" onclick="generateAndPrint()">Generate & Print</button>
        <button class="btn-excel" onclick="downloadExcel()">Download ID List (Excel)</button>
        <button class="btn-reset" onclick="resetSession()">Reset Session</button>
    </div>
    <div class="status-bar" id="statusMsg">
        Session Status: 0 IDs generated.
    </div>
</div>

<div id="print-container"></div>

<script>
// --- Global State to track Used IDs across the session ---
let usedIdsGlobal = new Set();
let excelDataGlobal = [];

function updateStatus() {
    const msg = document.getElementById('statusMsg');
    msg.textContent = `Session Status: ${usedIdsGlobal.size} IDs generated so far.`;
}

function resetSession() {
    if(confirm("Are you sure? This will clear the Excel download history for this session.")) {
        usedIdsGlobal = new Set();
        excelDataGlobal = [];
        document.getElementById('print-container').innerHTML = '';
        updateStatus();
    }
}

function generateRandomSuffix() {
    return Math.floor(100000 + Math.random() * 900000);
}

// Logic to generate QR code URL
function getQRUrl(uniqueID) {
    const baseUrl = 'https://www.tirangayuvasamiti.org/omr-verify/?id=' + uniqueID;
    return `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(baseUrl)}`;
}

// Function to build the internal grid logic
function buildGrid(gridContainer) {
    const cols = [document.createElement('div'), document.createElement('div'), document.createElement('div')];
    cols.forEach(c => c.className = 'q-column');

    function subjectRow(text) {
        const d = document.createElement('div');
        d.className = 'subject-row';
        d.textContent = text;
        return d;
    }

    for (let i = 1; i <= 90; i++) {
        if (i === 1) cols[0].appendChild(subjectRow('English (Q.1–15)'));
        if (i === 16) cols[0].appendChild(subjectRow('Hindi (Q.16–30)'));
        if (i === 31) cols[1].appendChild(subjectRow('Mental Ability (Q.31–45)'));
        if (i === 46) cols[1].appendChild(subjectRow('Computer Science (Q.46–60)'));
        if (i === 61) cols[2].appendChild(subjectRow('General Knowledge (Q.61–90)'));

        const row = document.createElement('div');
        row.className = 'q-row';
        row.innerHTML = `
            <div class="q-num">${i}.</div>
            <div class="options">
                <div class="opt-item">A<div class="bubble"></div></div>
                <div class="opt-item">B<div class="bubble"></div></div>
                <div class="opt-item">C<div class="bubble"></div></div>
                <div class="opt-item">D<div class="bubble"></div></div>
            </div>
        `;

        if (i <= 30) cols[0].appendChild(row);
        else if (i <= 60) cols[1].appendChild(row);
        else cols[2].appendChild(row);
    }
    cols.forEach(c => gridContainer.appendChild(c));
}

// Function to generate full pages
function generateAndPrint() {
    const container = document.getElementById('print-container');
    const count = parseInt(document.getElementById('sheetCount').value);
    
    // Clear only visual container, NOT the global history
    container.innerHTML = '';
    
    // Safety break loop
    let attempts = 0;
    const maxAttempts = 50000; 

    for (let i = 0; i < count; i++) {
        let suffix;
        let uniqueID;
        let isUnique = false;

        // Try to find a unique ID
        while (!isUnique) {
            attempts++;
            if (attempts > maxAttempts) {
                alert("Error: Could not generate unique ID after many attempts.");
                return;
            }

            suffix = generateRandomSuffix();
            uniqueID = 'TYSYGM2026' + suffix;
            
            // Check against GLOBAL history
            if (!usedIdsGlobal.has(uniqueID)) {
                isUnique = true;
                usedIdsGlobal.add(uniqueID);
            }
        }
        
        // Save to global data for Excel
        excelDataGlobal.push({
            id: uniqueID,
            url: 'https://www.tirangayuvasamiti.org/omr-verify/?id=' + uniqueID
        });

        const pageDiv = document.createElement('div');
        pageDiv.className = 'page';
        
        // Construct the HTML Structure
        pageDiv.innerHTML = `
            <div class="timing-mark tm-top" style="top:4mm; left:50%;"></div>
            <div class="timing-mark tm-bottom" style="bottom:4mm; left:50%;"></div>
            <div class="timing-mark tm-left" style="left:4mm; top:50%;"></div>
            <div class="timing-mark tm-right" style="right:4mm; top:50%;"></div>

            <div> <div class="header">
                <h1>TIRANGA YUVA SAMITI (GYAN SETU)</h1>
                <h2>YUVA GYAN MAHOTSAV 2026</h2>
                <img src="${getQRUrl(uniqueID)}" alt="QR Code" class="qr-code-img">
            </div>

            <div class="info-section">
                <div>
                    <div class="field">NAME:
                        <div class="box-wrap">
                            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
                            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
                            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
                            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
                        </div>
                    </div>
                    <div class="field">FATHER'S NAME:
                        <div class="box-wrap">
                            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
                            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
                            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
                            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
                        </div>
                    </div>
                    <div class="field">ROLL NO:
                        <div class="box-wrap">
                            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
                            <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="field">GROUP:
                        <div class="box-wrap">
                            <div class="box"></div><div class="box"></div>
                        </div>
                    </div>
                    <div class="field">CLASS:
                        <div class="box-wrap">
                            <div class="box"></div><div class="box"></div>
                        </div>
                    </div>
                    <div class="field">DATE:
                        <div class="box-wrap">
                            <div class="box">D</div><div class="box">D</div>
                            <div class="box">M</div><div class="box">M</div>
                            <div class="box">Y</div><div class="box">Y</div><div class="box">Y</div><div class="box">Y</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="secret-key">
                <div class="field">SECRET KEY:
                    <div class="box-wrap">
                        <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
                        <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
                        <div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div>
                    </div>
                </div>
            </div>

            <div class="instructions-bar">
                <div style="display:flex; align-items:center;">
                    <span class="inst-title">INSTRUCTIONS</span>
                    <ul class="inst-list">
                        <li>1. Use Blue/Black Ball Pen.</li>
                        <li>2. Darken circle completely.</li>
                        <li>3. No White Fluid.</li>
                    </ul>
                </div>
                <div class="visual-guide">
                    <span>Correct:</span><div class="bubble-guide" style="background:#000;"></div>
                    <span style="margin-left:8px;">Wrong:</span><div class="bubble-guide"></div>
                </div>
            </div>

            </div>

            <div class="omr-grid"></div>

            <div> <div class="official-use">
                <div class="official-header">For Official Use Only</div>
                <div class="score-grid">
                    <div><span class="score-label">CORRECT</span><div class="score-value"></div></div>
                    <div><span class="score-label">INCORRECT</span><div class="score-value"></div></div>
                    <div><span class="score-label">UNATTEMPTED</span><div class="score-value"></div></div>
                    <div><span class="score-label">POS. SCORE (+)</span><div class="score-value"></div></div>
                    <div><span class="score-label">NEG. SCORE (-)</span><div class="score-value"></div></div>
                </div>
                <div style="margin-top:6px;display:flex;justify-content:center;gap:10px;">
                    <strong>TOTAL OBTAINED SCORE:</strong>
                    <div class="score-value total-score" style="width:140px;"></div>
                </div>
            </div>

            <div class="footer">
                <div>
                    <div class="sign-box"></div>
                    <div class="box-label">Candidate Signature</div>
                </div>
                <div>
                    <div class="sign-box stamp-box">OFFICIAL<br>STAMP</div>
                </div>
                <div>
                    <div class="sign-box"></div>
                    <div class="box-label">Invigilator Signature</div>
                </div>
            </div>
            </div>
        `;

        // Inject the grid questions
        const gridContainer = pageDiv.querySelector('.omr-grid');
        buildGrid(gridContainer);
        
        container.appendChild(pageDiv);
    }
    
    updateStatus();

    // Trigger Print
    setTimeout(() => {
        window.print();
    }, 500);
}

// Function to generate CSV file for Excel
function downloadExcel() {
    if (excelDataGlobal.length === 0) {
        alert("No IDs generated yet!");
        return;
    }

    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Sheet ID,Verification URL\n"; // Header row

    excelDataGlobal.forEach(function(row) {
        csvContent += row.id + "," + row.url + "\n";
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "omr_sheet_ids_full_session.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Initial gen
window.onload = function() {
    generateAndPrint();
};
</script>

</body>
</html>
