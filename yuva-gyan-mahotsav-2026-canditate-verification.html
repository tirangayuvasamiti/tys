<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<div id="tys-verify-wrapper">

  <style>
    /* SCOPED STYLES */
    #tys-verify-wrapper {
      font-family: 'Montserrat', sans-serif;
      max-width: 500px;
      margin: 0 auto;
      text-align: center;
      padding: 20px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }

    .v-loader { color: #64748b; font-weight: 600; padding: 40px; }
    
    .v-res-box { display: none; background: white; padding: 20px; border-radius: 12px; border: 1px solid #ddd; }
    
    .v-badge {
      display: inline-block; padding: 8px 16px; border-radius: 50px; 
      font-weight: 800; font-size: 13px; text-transform: uppercase; margin-bottom: 20px;
    }
    .v-badge.success { background: #dcfce7; color: #166534; border: 1px solid #166534; }
    .v-badge.fail { background: #fee2e2; color: #991b1b; border: 1px solid #991b1b; }

    .v-img { width: 120px; height: 140px; object-fit: cover; border-radius: 8px; border: 3px solid #f1f5f9; margin-bottom: 15px; }
    
    .v-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
    .v-key { font-weight: 600; color: #64748b; }
    .v-val { font-weight: 800; color: #0f172a; text-align: right; }
  </style>

  <h3 style="margin-top:0; color:#002347;">Candidate Verification</h3>

  <div id="v-loading" class="v-loader">
    <i class="fa-solid fa-spinner fa-spin"></i> Checking Database...
  </div>

  <div id="v-success" class="v-res-box">
    <div class="v-badge success"><i class="fa-solid fa-check-circle"></i> Verified Official</div>
    
    <div style="display:flex; justify-content:center;">
       <img id="v-photo-display" class="v-img" src="" alt="Candidate">
    </div>

    <div class="v-row"><span class="v-key">Name:</span> <span class="v-val" id="v-name"></span></div>
    <div class="v-row"><span class="v-key">Roll No:</span> <span class="v-val" id="v-roll"></span></div>
    <div class="v-row"><span class="v-key">Exam:</span> <span class="v-val" id="v-exam"></span></div>
    <div class="v-row"><span class="v-key">Center:</span> <span class="v-val" id="v-center"></span></div>
  </div>

  <div id="v-fail" class="v-res-box">
    <div class="v-badge fail"><i class="fa-solid fa-triangle-exclamation"></i> Invalid / Fake</div>
    <p style="font-size:14px; color:#555;">
      The details in this QR code do not match our official records. This admit card may be forged.
    </p>
  </div>

</div>

<script>
(function() {
  // --- CONFIGURATION ---
  // Sheet 1: Existing
  const SHEET_ID_1 = "1blxXu3J9iuR3sVHILbZP54soLsouSrY_219mmHtl3Y0";
  // Sheet 2: New (Yuva Senior/Junior)
  const SHEET_ID_2 = "1digurE3sdXV8uAf4fpe1HyGuCKvA2ciCdtleg2_Gofg"; 
  
  const BASE_URL = "https://docs.google.com/spreadsheets/d/";
  const URL_PARAMS = "/export?format=csv";
  
  // Construct full URLs
  const CSV_URL_1 = BASE_URL + SHEET_ID_1 + URL_PARAMS;
  const CSV_URL_2 = BASE_URL + SHEET_ID_2 + URL_PARAMS;

  // --- LOGIC ---

  // Get URL Params
  const p = new URLSearchParams(window.location.search);
  const qRoll = p.get('roll');
  const qDob = p.get('dob');

  if(!qRoll || !qDob) {
    document.getElementById('v-loading').style.display = 'none';
    document.getElementById('v-fail').style.display = 'block';
    return;
  }

  // Fetch BOTH sheets in parallel
  Promise.all([
    fetch(CSV_URL_1 + "&t=" + Date.now()).then(r => r.arrayBuffer()),
    fetch(CSV_URL_2 + "&t=" + Date.now()).then(r => r.arrayBuffer())
  ])
  .then(([buffer1, buffer2]) => {
      // Parse Sheet 1
      const wb1 = XLSX.read(buffer1, {type:"array"});
      const data1 = XLSX.utils.sheet_to_json(wb1.Sheets[wb1.SheetNames[0]]);

      // Parse Sheet 2
      const wb2 = XLSX.read(buffer2, {type:"array"});
      const data2 = XLSX.utils.sheet_to_json(wb2.Sheets[wb2.SheetNames[0]]);

      // Merge Data
      const combinedData = [...data1, ...data2];
      
      const user = combinedData.find(u => {
         // Normalizing data comparisons
         let uRoll = String(u['roll_number'] || '').trim();
         let uDob = u['dob'];
         
         if(typeof uDob === 'number') {
             // Excel Date formatting logic
             const d = new Date(Math.round((uDob - 25569) * 86400 * 1000));
             uDob = `${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`;
         }
         uDob = String(uDob || '').trim();
         
         return uRoll === qRoll && uDob === qDob;
      });

      document.getElementById('v-loading').style.display = 'none';

      if(user) {
        document.getElementById('v-success').style.display = 'block';
        document.getElementById('v-name').innerText = user['candidate_name'];
        document.getElementById('v-roll').innerText = user['roll_number'];
        document.getElementById('v-exam').innerText = user['exam_name'] || 'Yuva Gyan Mahotsav';
        document.getElementById('v-center').innerText = user['exam_centre'];
        
        if(user['photo_url']) {
           document.getElementById('v-photo-display').src = `https://wsrv.nl/?url=${encodeURIComponent(user['photo_url'])}&output=png`;
        } else {
           document.getElementById('v-photo-display').style.display = 'none';
        }
      } else {
        document.getElementById('v-fail').style.display = 'block';
      }
  })
  .catch(e => {
       console.error(e);
       document.getElementById('v-loading').innerText = "Server Error (Check Console)";
  });

})();
</script>
