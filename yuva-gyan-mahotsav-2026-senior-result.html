<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&family=Oswald:wght@600;700&display=swap" rel="stylesheet">

<div id="tys-portal-wrapper">

  <style>
    /* === 1. PORTAL STYLES (Screen Only) === */
    #tys-portal-wrapper {
      font-family: 'Montserrat', sans-serif;
      width: 100%;
      box-sizing: border-box;
      color: #1e293b;
    }
    #tys-portal-wrapper * { box-sizing: border-box; }

    .tys-search-box {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      max-width: 450px;
      margin: 0 auto 30px auto;
      border: 1px solid #e2e8f0;
      text-align: center;
    }
    .tys-h2 { font-family: 'Oswald', sans-serif; font-size: 22px; color: #002347; text-transform: uppercase; margin: 0 0 10px 0; }

    .tys-field { margin-bottom: 12px; text-align: left; }
    .tys-lbl { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 4px; }
    .tys-inp {
      width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px;
      font-size: 15px; font-weight: 600; color: #333; outline: none;
    }
    .tys-inp:focus { border-color: #002347; }

    .tys-btn {
      width: 100%; padding: 12px; background: #002347; color: white; border: none;
      border-radius: 6px; font-weight: 700; font-size: 14px; cursor: pointer; text-transform: uppercase;
      margin-top: 5px;
    }
    .tys-btn:hover { background: #FF9933; }

    .tys-print-btn {
      background: #16a34a; margin-top: 10px; display: none;
    }

    #tys-status { margin-top: 10px; font-size: 13px; font-weight: 600; min-height: 20px; }

    /* Preview Container */
    #tys-card-preview {
      display: none;
      background: #e2e8f0;
      padding: 10px;
      border-radius: 8px;
      overflow-x: auto;
      text-align: center;
    }

    /* === 2. SCORECARD DESIGN (A4 Optimized) === */
    .ac-sheet {
      width: 210mm;
      min-height: 297mm;
      height: auto;
      background: white;
      margin: 0 auto;
      position: relative;
      text-align: left;
      padding: 10mm 12mm;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border: 1px solid #ccc;
      display: flex; flex-direction: column;

      background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiGBL0Jh6fzubFYEV5Pi4Ohcj7CvJlJpqNsGuTncuZmYklHd5Iw9IvG1I8YpWj3-2kYeg6RQBTA8MqYxhRnfHmf3VmGGn71-oBlVqPlHru3NxCJJ_tf-7ufuASffVOys-j553nZnnzzrwWiAXlxkjt4F2wygPlnqT3Vpb_qAwK9QJnK8Q/s1600/TYS-White.png');
      background-repeat: no-repeat;
      background-position: center 50%;
      background-size: 60%;
      background-color: rgba(255,255,255,0.97);
      background-blend-mode: overlay;
    }

    .ac-strip-top { position: absolute; top: 0; left: 0; width: 100%; height: 8px; background: linear-gradient(90deg, #FF9933, #ffffff, #138808); }
    .ac-strip-btm { position: absolute; bottom: 0; left: 0; width: 100%; height: 8px; background: #002347; }

    .ac-header { text-align: center; border-bottom: 2px solid #002347; padding-bottom: 5px; margin-bottom: 15px; }
    .ac-logo { width: 160px; height: auto; display: block; margin: 0 auto 5px auto; }
    .ac-title { font-family: 'Oswald', sans-serif; font-size: 28px; font-weight: 700; color: #002347; text-transform: uppercase; line-height: 1; margin-bottom: 2px; }
    .ac-sub { font-size: 13px; font-weight: 700; color: #e65100; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
    
    /* Academic Partner Style */
    .ac-partner { font-size: 11px; font-weight: 600; color: #333; margin-bottom: 5px; }
    .ac-partner a { color: #002347; text-decoration: none; font-weight: 800; }
    
    .ac-type-badge { background: #002347; color: #fff; display: inline-block; padding: 2px 10px; border-radius: 4px; font-size: 12px; font-weight: 700; text-transform: uppercase; margin-top: 2px; }

    .ac-main { display: flex; gap: 20px; }

    .ac-photo-col { width: 35mm; flex-shrink: 0; text-align: center; }
    .ac-photo-frame { width: 35mm; height: 45mm; border: 1px solid #000; background: #eee; margin-bottom: 5px; }
    .ac-photo-frame img { width: 100%; height: 100%; object-fit: cover; }
    .ac-qr-frame { background: white; padding: 2px; border: 1px solid #ddd; display: inline-block; }

    .ac-info-col { flex: 1; }
    .ac-row { display: flex; border-bottom: 1px dashed #ccc; padding: 5px 0; align-items: flex-end; }
    .ac-k { width: 140px; font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; }
    .ac-v { font-size: 15px; font-weight: 700; color: #000; flex: 1; line-height: 1.1; }

    /* Result Box Specifics */
    .ac-box {
      margin-top: 15px; border: 2px solid #002347; background: #f8fafc; border-radius: 6px;
      padding: 15px 15px; display: flex; justify-content: space-around; align-items: center;
      gap: 10px;
    }
    .ac-box-item { display: flex; flex-direction: column; align-items: center; text-align: center; width: 25%; position: relative; }
    .ac-box-item:not(:last-child)::after {
        content: ''; position: absolute; right: 0; top: 10%; height: 80%; width: 1px; background: #cbd5e1;
    }
    .ac-bi-k { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 4px; }
    .ac-bi-v { font-size: 20px; font-weight: 800; color: #002347; }
    .ac-score-val { color: #d97706; font-size: 24px; }
    .ac-rank-val { color: #16a34a; font-size: 24px; }

    .ac-instr { margin-top: 15px; border-top: 1px solid #333; padding-top: 5px; flex: 1; }
    .ac-instr h4 { font-size: 12px; text-transform: uppercase; text-decoration: underline; margin: 0 0 5px 0; }
    .ac-instr ul { margin: 0; padding-left: 20px; font-size: 10px; line-height: 1.6; color: #333; }
    .ac-instr li { margin-bottom: 3px; text-align: justify; }

    /* Ending Message */
    .ac-msg-area {
        text-align: center; margin-top: 20px; padding: 10px; background: #f0f9ff; 
        border-radius: 8px; border: 1px dashed #0ea5e9;
    }
    .ac-msg-quote { font-family: 'Times New Roman', serif; font-style: italic; font-size: 14px; color: #555; margin-bottom: 5px; }
    .ac-msg-thx { font-weight: 700; color: #002347; font-size: 12px; text-transform: uppercase; }

    .ac-controller-area {
      text-align: right; margin-top: 10px; padding-right: 10px; height: 60px; position: relative;
    }
    .ac-ctrl-stamp {
      position: absolute; right: 0; bottom: 0; width: 100px; mix-blend-mode: multiply; transform: rotate(-5deg); opacity: 0.9;
    }
    .ac-ctrl-lbl {
      position: absolute; right: 0; bottom: -12px; font-size: 10px; font-weight: 700; border-top: 1px solid #000; padding-top: 2px;
    }

    /* === 3. MOBILE PREVIEW SCALE (SCREEN ONLY) === */
    @media screen and (max-width: 800px) {
      .ac-sheet {
        transform: scale(0.40);
        transform-origin: top center;
        margin-bottom: -180mm;
      }
    }

    /* === 4. PRINT === */
    @media print {
      @page { size: A4 portrait; margin: 0mm; }

      html, body {
        margin: 0 !important; padding: 0 !important; background: #fff !important;
        -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
      }
      body * { visibility: hidden !important; }
      #tys-card-preview, #tys-card-preview * { visibility: visible !important; }
      #tys-card-preview {
        display: block !important; position: fixed !important; left: 0 !important; top: 0 !important;
        width: 210mm !important; padding: 0 !important; margin: 0 !important; background: #fff !important;
      }
      .ac-sheet {
        transform: none !important; width: 210mm !important; height: 296mm !important;
        margin: 0 !important; border: none !important; box-shadow: none !important;
      }
      /* Ensure partner link looks black in print */
      .ac-partner a { color: #000 !important; text-decoration: none !important; }
    }
  </style>

  <div class="tys-search-box">
    <div class="tys-h2">Check Results</div>
    <div class="tys-field">
      <label class="tys-lbl">Roll Number</label>
      <input type="text" id="inp-roll" class="tys-inp" placeholder="e.g. YGM26J0001">
    </div>
    <div class="tys-field">
      <label class="tys-lbl">Date of Birth</label>
      <input type="text" id="inp-dob" class="tys-inp" placeholder="DD-MM-YYYY">
    </div>
    <button class="tys-btn" onclick="runSearch()">Show Result</button>

    <button class="tys-btn tys-print-btn" id="btn-print" onclick="window.print()">
      <i class="fa-solid fa-print"></i> Print Scorecard
    </button>

    <div id="tys-status"></div>
  </div>

  <div id="tys-card-preview"></div>
</div>

<script>
(function() {
  // === CONFIGURATION ===
  const CSV_SOURCE = "https://docs.google.com/spreadsheets/d/1digurE3sdXV8uAf4fpe1HyGuCKvA2ciCdtleg2_Gofg/export?format=csv";
  const VERIFY_URL_BASE = "https://www.tirangayuvasamiti.org/ygm-26-result-verify/";
  const LOGO_SRC = "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj07rF4-GwTBQPt4E0zIrcwJ7LUTusJ_fULWzlgbbLy81y7l0RrBEDRLpN9evj-1MBilAd6xq97HIU-p9A-5RZ4mZ7GmkxcsTpUyaxyimY7id2jGVRXAzWlMsh-M8Tuz7_k9CN8vznJIZCU73xEk5ICSC81esAjJ592RFlbYwgFHGuqIg/s1600/Logo_TYS_Exam.png";
  const STAMP_SRC = "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj72nNAiChUf9ROOPiYDrwg4RSatVygGQEt7yW1lOmQosfBW9MB2V3qZAcYcOHH-0bAb_2QBZSUsL_9xdVIdpZdvVOha0czW1ssESptg8Mg3X6W8K1DuyPio_oh6X4DdNH2xUhRc2fX1AkpJh2RuPYl5b0a16nYSTgGrkQnKuwYvz3lsQ/s1600/Lokesh%20Stamp.jpg";

  // MAPPING: Ensure your CSV has columns for 'marks' and 'rank'
  const M = {
    roll: "roll_number",
    dob: "dob",
    name: "candidate_name",
    father: "father_name",
    class: "class",
    group: "group",
    mobile: "mobile",
    address: "address",
    aadhaar: "aadhaar_number",
    photo: "photo_url",
    marks: "marks",        // NEW FIELD
    rank: "rank"          // NEW FIELD
  };

  const TOTAL_MARKS_FIXED = 360;

  let DB = [];

  // Load Database
  fetch(CSV_SOURCE + "&t=" + Date.now())
    .then(r => r.arrayBuffer())
    .then(ab => {
      const wb = XLSX.read(ab, {type:"array"});
      DB = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    });

  window.runSearch = function() {
    const r = document.getElementById('inp-roll').value.trim();
    const d = document.getElementById('inp-dob').value.trim();
    const msg = document.getElementById('tys-status');
    const view = document.getElementById('tys-card-preview');
    const pBtn = document.getElementById('btn-print');

    if(!r || !d) { msg.innerHTML = "<span style='color:red'>Enter details.</span>"; return; }
    if(!DB.length) { msg.innerHTML = "Loading database..."; return; }

    msg.innerText = "Searching results...";

    const u = DB.find(x => {
      let xr = String(x[M.roll]).trim();
      let xd = x[M.dob];
      if(typeof xd === 'number') xd = fmtDate(xd);
      return xr == r && String(xd).trim() == d;
    });

    if(u) {
      msg.innerHTML = "";
      render(u);
      view.style.display = 'block';
      pBtn.style.display = 'block';
      setTimeout(() => view.scrollIntoView({behavior:'smooth'}), 300);
    } else {
      msg.innerHTML = "<span style='color:red'>Result not found. Check details.</span>";
      view.style.display = 'none';
      pBtn.style.display = 'none';
    }
  };

  function render(data) {
    const el = document.getElementById('tys-card-preview');
    const pic = data[M.photo] ? `https://wsrv.nl/?url=${encodeURIComponent(data[M.photo])}&output=png` : '';
    const dobText = fmtDate(data[M.dob]);

    // CALCULATIONS
    const marksObt = parseFloat(data[M.marks]) || 0;
    const rank = data[M.rank] || "N/A";
    const percentage = ((marksObt / TOTAL_MARKS_FIXED) * 100).toFixed(1);
    
    // QR Generation (URL)
    const qrLink = `${VERIFY_URL_BASE}?roll=${encodeURIComponent(data[M.roll])}&score=${marksObt}&rank=${encodeURIComponent(rank)}`;

    el.innerHTML = `
      <div class="ac-sheet">
        <div class="ac-strip-top"></div>

        <div class="ac-header">
           <img src="${LOGO_SRC}" class="ac-logo">
           <div class="ac-title">YUVA GYAN MAHOTSAV 2026</div>
           <div class="ac-sub">Organised By: Tiranga Yuva Samiti</div>
           <div class="ac-partner">
              Academic Partner: <a href="https://www.academichalt.com/" target="_blank">Academic Halt</a>
           </div>
           <div class="ac-type-badge">OFFICIAL SCORECARD</div>
        </div>

        <div class="ac-main">
           <div class="ac-photo-col">
              <div class="ac-photo-frame">
                 ${pic ? `<img src="${pic}">` : ''}
              </div>
              <div id="qr-target" class="ac-qr-frame"></div>
           </div>

           <div class="ac-info-col">
              <div class="ac-row"><span class="ac-k">Roll Number</span><span class="ac-v" style="font-size:18px">${data[M.roll]}</span></div>
              <div class="ac-row"><span class="ac-k">Candidate Name</span><span class="ac-v">${data[M.name] || ""}</span></div>
              <div class="ac-row"><span class="ac-k">Father's Name</span><span class="ac-v">${data[M.father] || ""}</span></div>
              <div class="ac-row"><span class="ac-k">Date of Birth</span><span class="ac-v">${dobText}</span></div>
              <div class="ac-row"><span class="ac-k">Class</span><span class="ac-v">${data[M.class] || ""}</span></div>
              <div class="ac-row"><span class="ac-k">Category</span><span class="ac-v">${data[M.group] || ""}</span></div>
              <div class="ac-row"><span class="ac-k">Mobile</span><span class="ac-v">${data[M.mobile] || ""}</span></div>
              <div class="ac-row"><span class="ac-k">Address</span><span class="ac-v" style="font-size:11px">${data[M.address] || ""}</span></div>
           </div>
        </div>

        <div class="ac-box">
           <div class="ac-box-item">
              <span class="ac-bi-k">Total Marks</span>
              <span class="ac-bi-v">${TOTAL_MARKS_FIXED}</span>
           </div>
           <div class="ac-box-item">
              <span class="ac-bi-k">Marks Obtained</span>
              <span class="ac-bi-v ac-score-val">${marksObt}</span>
           </div>
           <div class="ac-box-item">
              <span class="ac-bi-k">Percentage</span>
              <span class="ac-bi-v">${percentage}%</span>
           </div>
           <div class="ac-box-item">
              <span class="ac-bi-k">Your Rank</span>
              <span class="ac-bi-v ac-rank-val">#${rank}</span>
           </div>
        </div>

        <div class="ac-instr">
           <h4>Result Notes & Disclaimer:</h4>
           <ul>
              <li><strong>Provisional Result:</strong> This scorecard is provisional. Tiranga Yuva Samiti reserves the right to rectify any inadvertent error/omission in the result at any stage.</li>
              <li><strong>Tie-Breaking Policy:</strong> In case of equal marks, rank is decided based on the candidate's age (younger candidate gets preference) or Subject specific scores as per TYS norms.</li>
              <li><strong>Scholarship/Prize Claims:</strong> Candidates must produce this printed scorecard along with original Aadhaar Card and School ID during the prize distribution ceremony.</li>
              <li><strong>Documents Verification:</strong> All merit holders are subject to physical document verification. Any discrepancy found in DOB or Identity will lead to disqualification.</li>
              <li><strong>Re-checking:</strong> Requests for re-calculation of marks must be submitted to the Controller of Examination within 7 days of result declaration with the prescribed fee.</li>
              <li><strong>Validity:</strong> This scorecard is valid only for the "Yuva Gyan Mahotsav 2026" session.</li>
           </ul>
        </div>

        <div class="ac-msg-area">
            <div class="ac-msg-quote">"Success is not final, failure is not fatal: It is the courage to continue that counts."</div>
            <div class="ac-msg-thx">Thank You for Participating & Best Wishes for Your Future!</div>
        </div>

        <div class="ac-controller-area">
           <img src="${STAMP_SRC}" class="ac-ctrl-stamp">
           <div class="ac-ctrl-lbl">Controller of Examination</div>
        </div>

        <div class="ac-strip-btm"></div>
      </div>
    `;

    setTimeout(() => {
       const q = document.getElementById('qr-target');
       if (!q) return;
       q.innerHTML = "";
       new QRCode(q, { text: qrLink, width: 80, height: 80 });
    }, 120);
  }

  function fmtDate(v) {
    if(!v) return "";
    if(typeof v === 'number') {
      const d = new Date(Math.round((v - 25569) * 86400 * 1000));
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      return `${dd}-${mm}-${d.getFullYear()}`;
    }
    return String(v).trim();
  }
})();
</script>
