<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700;800&family=Rozha+One&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* === GLOBAL RESET === */
    html, body {
        margin: 0; padding: 0;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        min-height: 100vh;
        -webkit-print-color-adjust: exact; print-color-adjust: exact;
        overflow-x: hidden;
    }

    /* === NEW MODERN VERIFICATION UI === */
    #tys-app-container {
        font-family: 'Poppins', sans-serif;
        width: 100%;
        padding: 40px 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
    }
    #tys-app-container * { box-sizing: border-box; }

    /* Modern Control Box */
    #tys-app-container .controls-box {
        background: #ffffff;
        width: 95%;
        max-width: 600px;
        padding: 45px;
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        margin-bottom: 50px;
        animation: fadeInUp 0.8s ease-out;
        position: relative;
        overflow: hidden;
    }
    
    .controls-box::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(90deg, #ff6b35 0%, #f7931e 50%, #ff6b35 100%);
    }

    /* Header Section */
    .tys-header {
        margin-bottom: 35px;
        text-align: center;
        padding-bottom: 25px;
        border-bottom: 2px solid #e8e8e8;
    }
    
    .tys-header h2 {
        color: #1a1a2e;
        margin: 0 0 10px 0;
        font-size: 26px;
        font-weight: 800;
        font-family: 'Noto Sans Devanagari', sans-serif;
    }
    
    .tys-header p {
        color: #555555;
        font-size: 15px;
        margin: 0;
        font-weight: 500;
    }

    /* Input Groups */
    .tys-input-group {
        margin-bottom: 28px;
    }
    
    .input-label {
        font-size: 14px;
        font-weight: 700;
        color: #1a1a2e;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .input-label i {
        color: #ff6b35;
        font-size: 18px;
    }

    /* Modern Input Fields */
    #tys-app-container .input-wrapper {
        position: relative;
    }
    
    #tys-app-container .input-field {
        width: 100%;
        padding: 18px 20px 18px 55px;
        background: #f5f5f5;
        border: 2px solid #d0d0d0;
        border-radius: 12px;
        font-size: 17px;
        font-family: 'Poppins', sans-serif;
        color: #1a1a2e;
        transition: all 0.3s ease;
        font-weight: 600;
    }
    
    #tys-app-container .input-icon {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: #ff6b35;
        font-size: 20px;
        pointer-events: none;
    }
    
    #tys-app-container .input-field:focus {
        outline: none;
        background: #ffffff;
        border-color: #ff6b35;
        box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.15);
    }
    
    #tys-app-container .input-field::placeholder {
        color: #888888;
        font-size: 15px;
        font-weight: 500;
    }

    /* Modern Button */
    #tys-app-container .btn-verify {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: #ffffff;
        border: none;
        padding: 20px;
        border-radius: 12px;
        font-size: 17px;
        font-weight: 800;
        cursor: pointer;
        width: 100%;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        box-shadow: 0 8px 24px rgba(255, 107, 53, 0.4);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-top: 35px;
    }
    
    #tys-app-container .btn-verify:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 32px rgba(255, 107, 53, 0.5);
        background: linear-gradient(135deg, #f7931e 0%, #ff6b35 100%);
    }
    
    #tys-app-container .btn-verify:active {
        transform: translateY(0);
    }

    /* Status Box */
    #tys-status {
        text-align: center;
        font-size: 15px;
        font-weight: 700;
        min-height: 24px;
        padding: 18px;
        background: #f0f0f0;
        border-radius: 10px;
        margin-top: 25px;
        border: 2px solid #d0d0d0;
        color: #333333;
    }
    
    #tys-status.success {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }
    
    #tys-status.error {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    /* Security Badge */
    .security-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 25px;
        padding-top: 25px;
        border-top: 2px solid #e8e8e8;
        color: #666666;
        font-size: 13px;
        font-weight: 600;
    }
    
    .security-badge i {
        color: #28a745;
        font-size: 18px;
    }

    /* Animations */
    @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    #tys-grid {
        display: flex;
        flex-direction: column;
        gap: 40px;
        align-items: center;
        width: 100%;
    }

    /* === GRID RESULT STYLES === */
    .card-row {
        display: flex; flex-wrap: wrap; gap: 40px; justify-content: center;
        background: #ffffff; padding: 40px; border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        border: 1px solid #eee; width: 95%; max-width: 100%;
        animation: fadeInUp 0.5s ease-out;
    }
    .btn-print-wrap { width: 100%; display: flex; justify-content: center; margin-top: 20px; }
    .btn-print { 
        background: #d62d20; color: white; padding: 14px 30px; border: none; 
        border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 700;
        display: inline-flex; align-items: center; gap: 10px;
        box-shadow: 0 4px 10px rgba(214, 45, 32, 0.3);
    }

    @media (max-width: 768px) {
        #tys-app-container { padding: 20px 5px !important; }
        #tys-app-container .controls-box { width: 100% !important; padding: 30px 15px; border-radius: 16px; }
        .card-row { width: 100% !important; padding: 20px 10px; gap: 20px; }
        .id-card-wrapper { transform: scale(0.95); transform-origin: center top; margin-bottom: -15px; }
    }

    /* === ID CARD CSS === */
    .id-card-wrapper {
        width: 96mm; height: 65mm;
        position: relative; margin: 0 auto;
        border-radius: 0;
        box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }

    .id-card-inner {
        width: 96mm; height: 65mm;
        background-color: #ffffff;
        background-image: radial-gradient(#002347 0.5px, transparent 0.5px), radial-gradient(#002347 0.5px, #ffffff 0.5px);
        background-size: 20px 20px; background-position: 0 0, 10px 10px; background-blend-mode: overlay;
        position: relative; overflow: hidden;
        border: 1px solid #aaa; border-radius: 0;
        font-family: 'Noto Sans Devanagari', sans-serif;
        display: flex; flex-direction: column; color: #000; line-height: normal;
    }

    /* HEADER */
    .h-header { 
        height: 16mm;
        background: #002347; 
        display: flex; align-items: center; justify-content: space-between; 
        padding: 0 2mm; position: relative; z-index: 5;
        border-bottom: 1.8mm solid #d62d20; 
    }
    .h-logo, .h-cow { width: 14.5mm; height: 14.5mm; object-fit: contain; display: block; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
    .h-cow { border-radius: 50%; border: 1px solid white; background:white; object-fit: cover; }
    
    .h-titles { flex: 1; text-align: center; padding-top: 3.5mm; } 
    .h-main-title { 
        font-family: 'Rozha One', serif; font-size: 13.5pt; color: #ffffff; 
        line-height: 0.9; margin-top: 0; white-space: nowrap; 
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .h-sub-title { 
        font-family: 'Noto Sans Devanagari', sans-serif; font-size: 6pt;
        font-weight: 700; color: #ffeb3b; line-height: 1.2; margin-top: 0.5mm; 
    }
    
    .h-tag { 
        position: absolute; top: 0; left: 50%; transform: translateX(-50%); 
        font-size: 4pt;
        background: #d62d20; color: white; padding: 1px 8px; 
        border-radius: 0;
        text-transform: uppercase; font-weight: 800; 
        z-index: 10;
    }

    /* BODY */
    .h-body { 
        flex: 1; display: flex; flex-direction: column;
        padding: 2mm 3mm;
        position: relative; background: rgba(255,255,255,0.94); 
    }
    
    .bg-wm { 
        position: absolute; 
        top: 40%; 
        left: 50%; 
        transform: translate(-50%, -50%); 
        width: 30mm;
        opacity: 0.08; 
        pointer-events: none; 
        z-index: 0; 
        filter: grayscale(100%); 
    }

    .h-content-row { display: flex; width: 100%; flex: 1; }

    .h-left { width: 25mm; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
    
    .h-p-box { 
        width: 100%; height: 30mm;
        background: #fff; 
        position: relative; border: 1.5px solid #002347; border-radius: 0; overflow: hidden;
    }
    .h-p-img { width: 100%; height: 100%; object-fit: cover; }
    
    .h-stamp { 
        position: absolute; bottom: 0; right: 0; width: 14mm; 
        opacity: 0.9; mix-blend-mode: multiply; transform: rotate(-15deg); z-index: 10;
        display: none !important;
    }

    .h-sign-box { width: 100%; text-align: center; margin-top: 1mm; flex-shrink: 0; }
    .h-sign-img { height: 7mm; width: auto; max-width: 100%; display: block; margin: 0 auto; mix-blend-mode: multiply; }
    .h-sign-lbl { 
        font-size: 4pt; color: #002347; font-weight: 700; 
        border-top: 0.5px solid #000; padding-top: 0.5px; display: block; width: 100%;
    }

    .h-right { flex: 1; padding-left: 5mm; display: flex; flex-direction: column; position: relative; }
    
    .h-row-id { 
        font-size: 10pt; font-weight: 800; color: #d62d20;
        border-bottom: 1px dashed #002347; margin-bottom: 1.5mm; padding-bottom: 0.5mm;
        display: block; width: 100%; text-align: center; font-family: 'Poppins', sans-serif;
    }
    
    .h-grid { display: grid; grid-template-columns: 20mm 1fr; row-gap: 1.5mm; font-size: 7.5pt; }
    .hl { color: #002347; font-weight: 800; margin: 0; padding: 0; }
    .hv { color: #000; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0; padding: 0; }

    .h-barcode-row {
        width: 100%; height: 11mm;
        display: flex; justify-content: center; align-items: center;
        margin-top: 1mm; padding-top: 1mm;
        border-top: 0.5px dotted #ccc;
    }
    .h-bar-wrap { width: 95%; height: 100%; display: flex; justify-content: center; }
    .h-bar-wrap svg { width: 100%; height: 100%; }

    .h-footer { 
        height: 5mm; background: #002347; color: white; 
        display: flex; align-items: center; justify-content: center; 
        font-size: 4pt; font-weight: 600; text-align: center; line-height: 1.1; 
        letter-spacing: 0px; border-top: 1px solid #d62d20; white-space: nowrap;
    }

    /* BACK SIDE */
    .vb-c { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 2mm 3mm 6mm 3mm; text-align: center; background: rgba(255,255,255,0.95); }
    .h-header-back-title { margin-top: 2mm; color: white; font-family: 'Noto Sans Devanagari'; font-size: 12pt; font-weight: 700; }
    
    .vb-contact {
        margin-bottom: 2mm; font-size: 5pt; color: #002347; font-weight: 800; 
        border-bottom: 1px dashed #d62d20; padding-bottom: 1px; width: 95%; white-space: nowrap; overflow: hidden;
    }

    /* --- MODIFIED QR SECTION --- */
    /* Container for two QR codes side by side */
    .vb-qr-row { 
        display: flex; 
        justify-content: center; 
        align-items: center;
        gap: 3mm; 
        margin-bottom: 2mm; 
        width: 100%;
    }
    /* Resized QR Box to fit two */
    .vb-qr-small { 
        width: 22mm; height: 22mm; 
        border: 1.5px solid #002347; 
        padding: 1px; 
        background: white; 
        border-radius: 0;
    }
    .vb-qr-small img { width: 100%; height: 100%; display: block; }

    .vb-t { font-size: 9pt; font-weight: 800; color: #002347; margin-bottom: 1mm; text-transform: uppercase; }
    .vb-s { font-size: 6.5pt; color: #444; width: 85%; font-weight: 600; line-height: 1.3; }
</style>

<div id="tys-app-container">
    <div class="controls-box">
        <div class="tys-header">
            <h2>सदस्यता सत्यापन</h2>
            <p>कृपया अपनी जानकारी दर्ज करें</p>
        </div>

        <div class="tys-input-group">
            <label class="input-label">
                <i class="fa-solid fa-id-card-clip"></i>
                सदस्यता आईडी (Member ID)
            </label>
            <div class="input-wrapper">
                <i class="fa-solid fa-hashtag input-icon"></i>
                <input type="text" id="tysInputId" class="input-field" placeholder="उदाहरण: TYS-GRD-TYM-121">
            </div>
        </div>

        <div class="tys-input-group">
            <label class="input-label">
                <i class="fa-solid fa-mobile-screen-button"></i>
                मोबाइल नंबर (Phone Number)
            </label>
            <div class="input-wrapper">
                <i class="fa-solid fa-phone input-icon"></i>
                <input type="text" id="tysInputPhone" class="input-field" placeholder="उदाहरण: 9053575169">
            </div>
        </div>

        <button class="btn-verify" onclick="tysVerify()">
            <i class="fa-solid fa-shield-check"></i>
            सत्यापित करें (Verify Now)
        </button>

        <div id="tys-status">
            <i class="fa-solid fa-circle-check"></i> सिस्टम तैयार है...
        </div>

        <div class="security-badge">
            <i class="fa-solid fa-lock"></i>
            <span>सुरक्षित और एन्क्रिप्टेड सत्यापन</span>
        </div>
    </div>

    <div id="tys-grid"></div>
</div>

<script>
    // === CONFIGURATION ===
    const EXCEL_URL = "https://docs.google.com/spreadsheets/d/1ehEiwGskDIHwUHJMSWrbjpSsaA8fTSkJ6hfuFLV3jhI/export?format=csv";
    const SIGN_URL = "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj72nNAiChUf9ROOPiYDrwg4RSatVygGQEt7yW1lOmQosfBW9MB2V3qZAcYcOHH-0bAb_2QBZSUsL_9xdVIdpZdvVOha0czW1ssESptg8Mg3X6W8K1DuyPio_oh6X4DdNH2xUhRc2fX1AkpJh2RuPYl5b0a16nYSTgGrkQnKuwYvz3lsQ/s1600/Lokesh%20Stamp.jpg";

    const ASSETS = {
        logo: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhCaJCRPLvQgi9REoAvb9b4H4Vvh6RhAmMRGwGEolXIqS2nxxCa9-jS7qexF2JL5puwPOEk-2q7ubDKeL-m-BM0_7_uHrI5EnBXue7deGtgta4UyCDnI43AkB1KBN8PV4G00fg1vW2La338AyzZkHvXpzt49papqeYLt9NDXMcTnvsceg/s1600/TYS-White.png",
        cow: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj4jRFVp4bz-d45e1q-rgRwa4yOre7RBcKtS-dxVu9ayVmpGTs8rHNx6M8xnO5zLkvS7_MOU2_l6k5i6J56mN5FymgLK9IE5eIDdfp2aNEB3xmrAHp8YzzRJ-5OZeT0-uRI_eeo3gE-ZQNFK-FuHmr9Cl_gYVVeFE7bHljkejal8S2LBw/s1600/cow-calf-image.jpg",
        stamp: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj72nNAiChUf9ROOPiYDrwg4RSatVygGQEt7yW1lOmQosfBW9MB2V3qZAcYcOHH-0bAb_2QBZSUsL_9xdVIdpZdvVOha0czW1ssESptg8Mg3X6W8K1DuyPio_oh6X4DdNH2xUhRc2fX1AkpJh2RuPYl5b0a16nYSTgGrkQnKuwYvz3lsQ/s1600/Lokesh%20Stamp.jpg"
    };

    const FIELDS = {
        id: "id", first: "firstname", last: "lastname", father: "father_name",
        phone: "phone", dob: "dob", blood: "blood_group", address: "address",
        validity: "validity", photo: "photo_url", qr_data: "qr_url", designation: "designation"
    };

    let TYS_DATA = [];

    document.addEventListener("DOMContentLoaded", function() {
        loadTysData();
    });

    function getProxy(url) {
        if(!url) return "https://via.placeholder.com/150";
        return `https://wsrv.nl/?url=${encodeURIComponent(url)}&output=png`;
    }

    async function loadTysData() {
        const status = document.getElementById('tys-status');
        if(!status) return;
        status.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> डेटा लोड हो रहा है...';
        try {
            const resp = await fetch(EXCEL_URL + "&t=" + Date.now());
            const buffer = await resp.arrayBuffer();
            const decoder = new TextDecoder("utf-8");
            const csvData = decoder.decode(buffer);
            const workbook = XLSX.read(csvData, {type: 'string'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            TYS_DATA = XLSX.utils.sheet_to_json(sheet);
            status.innerHTML = `<i class="fa-solid fa-circle-check"></i> <span style="color:#28a745">डेटाबेस कनेक्ट हो गया।</span>`;
        } catch (e) {
            console.error(e);
            status.innerHTML = '<span style="color:#dc3545"><i class="fa-solid fa-circle-xmark"></i> कनेक्शन विफल।</span>';
        }
    }

    function formatDate(val) {
        if (!val) return "";
        const d = new Date(val);
        if (isNaN(d.getTime())) return val; 
        return `${d.getDate().toString().padStart(2,'0')}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getFullYear()}`;
    }

    function tysVerify() {
        let inId = document.getElementById('tysInputId').value.trim().toLowerCase();
        let inPhone = document.getElementById('tysInputPhone').value.trim();
        const grid = document.getElementById('tys-grid');
        const status = document.getElementById('tys-status');

        if (!inId || !inPhone) {
            status.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> कृपया दोनों विवरण भरें।';
            status.className = 'error';
            return;
        }

        const found = TYS_DATA.find(m => {
            const mId = String(m[FIELDS.id]||'').trim().toLowerCase();
            const mPh = String(m[FIELDS.phone]||'').trim();
            return mId.includes(inId) && mPh.includes(inPhone);
        });

        if (!found) {
            status.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> <span style="color:#dc3545">विवरण गलत है।</span>';
            status.className = 'error';
            grid.innerHTML = '';
            return;
        }

        status.innerHTML = '<i class="fa-solid fa-circle-check"></i> <span style="color:#28a745">सत्यापन सफल!</span>';
        status.className = 'success';
        tysRender(found);
    }

    function tysRender(data) {
        const grid = document.getElementById('tys-grid');
        const fullID = data[FIELDS.id] || "000"; 
        const name = `${data[FIELDS.first] || ''} ${data[FIELDS.last] || ''}`.trim();
        const father = data[FIELDS.father] || "";
        const phone = data[FIELDS.phone] || "";
        const dob = formatDate(data[FIELDS.dob]) || "________";
        const validityDate = formatDate(data[FIELDS.validity]) || "Lifetime";
        const address = data[FIELDS.address] || "गांव खांडा";
        const blood = data[FIELDS.blood] || "";
        const designation = data[FIELDS.designation] || "सदस्य";
        
        // Old QR Data
        let qrText = data[FIELDS.qr_data];
        if (!qrText) qrText = `https://www.tirangayuvasamiti.org/verify?id=${fullID}`;

        // New QR Data Logic
        let newQrText = `https://www.tirangayuvasamiti.org/grd-id-card-verification/?id=${fullID}`;

        const photoUrl = getProxy(data[FIELDS.photo]);
        const logoUrl = getProxy(ASSETS.logo);
        const cowUrl = getProxy(ASSETS.cow);
        const stampUrl = getProxy(ASSETS.stamp);
        const signatureUrl = getProxy(SIGN_URL);

        const safeId = fullID.replace(/[^a-zA-Z0-9]/g, ''); 
        const frontId = `cf-${safeId}`;
        const backId = `cb-${safeId}`;

        grid.innerHTML = `
            <div class="card-row">
                <div>
                    <div style="text-align:center; font-weight:bold; color:#002347; margin-bottom:5px;">FRONT SIDE</div>
                    <div class="id-card-wrapper">
                        <div class="id-card-inner" id="${frontId}">
                            <div class="h-header">
                                <div class="h-tag">पहचान पत्र</div>
                                <img src="${logoUrl}" class="h-logo" crossorigin="anonymous">
                                <div class="h-titles">
                                    <div class="h-main-title">गो रक्षा दल (हरियाणा)</div>
                                    <div class="h-sub-title">तिरंगा युवा समिति (पंजी. सं. 01820)<br>गांव खांडा, तहसील खरखौदा, सोनीपत (हरियाणा)</div>
                                </div>
                                <img src="${cowUrl}" class="h-cow" crossorigin="anonymous">
                            </div>
                            <div class="h-body">
                                <img src="${logoUrl}" class="bg-wm" crossorigin="anonymous">
                                
                                <div class="h-content-row">
                                    <div class="h-left">
                                        <div class="h-p-box">
                                            <img src="${photoUrl}" class="h-p-img" crossorigin="anonymous">
                                            <img src="${stampUrl}" class="h-stamp" crossorigin="anonymous">
                                        </div>
                                        <div class="h-sign-box">
                                            <img src="${signatureUrl}" class="h-sign-img" crossorigin="anonymous"> 
                                            <span class="h-sign-lbl">(अधिकृत हस्ताक्षर)</span>
                                        </div>
                                    </div>
                                    <div class="h-right">
                                        <div class="h-row-id">क्रमांक: ${fullID}</div>
                                        <div class="h-grid">
                                            <div class="hl">नाम:</div><div class="hv" style="font-size:8.5pt; color:#002347;">${name}</div>
                                            <div class="hl">पिता का नाम:</div><div class="hv">${father}</div>
                                            <div class="hl">जन्म तिथि:</div><div class="hv">${dob}</div>
                                            <div class="hl">पद:</div><div class="hv"><span style="background:#d62d20; color:white; padding:1px 6px; border-radius:0; display:inline-block; font-size:7pt; line-height:1.2;">${designation}</span></div>
                                            <div class="hl">मोबाइल:</div><div class="hv">${phone}</div>
                                            <div class="hl">पता:</div><div class="hv" style="font-size:6.5pt; line-height:1.2; white-space:normal;">${address}</div>
                                            <div class="hl">वैधता:</div>
                                            <div class="hv" style="display:flex; justify-content:space-between;">
                                                <span>${validityDate}</span>
                                                <span style="font-size:6.5pt; color:#d62d20; font-weight:800;">रक्त समूह: <span style="color:black;">${blood}</span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="h-barcode-row">
                                    <div class="h-bar-wrap"><svg id="bar-${safeId}"></svg></div>
                                </div>

                            </div>
                            <div class="h-footer">संपर्क सूत्र: +91 90535 75169 | info@tirangayuvasamiti.org | www.tirangayuvasamiti.org</div>
                        </div>
                    </div>
                </div>
                <div>
                    <div style="text-align:center; font-weight:bold; color:#002347; margin-bottom:5px;">BACK SIDE</div>
                    <div class="id-card-wrapper">
                        <div class="id-card-inner" id="${backId}">
                            <div class="h-header" style="justify-content:center; background:#002347; border-bottom: 2mm solid #d62d20;">
                                <div class="h-header-back-title">सत्यापन और नियम</div>
                            </div>
                            <div class="h-body vb-c">
                                <div class="vb-contact">संपर्क सूत्र: +91 90535 75169 | info@tirangayuvasamiti.org | www.tirangayuvasamiti.org</div>
                                <div class="vb-t">सदस्यता सत्यापित करने के लिए स्कैन करें</div>
                                
                                <div class="vb-qr-row">
                                    <div id="qr-old-${safeId}" class="vb-qr-small"></div>
                                    <div id="qr-new-${safeId}" class="vb-qr-small"></div>
                                </div>

                                <div class="vb-s">यह कार्ड तिरंगा युवा समिति की संपत्ति है।<br>गुम होने पर कृपया उपरोक्त पते पर लौटाएं।</div>
                                <div style="margin-top:2mm; font-weight:800; color:#d62d20; font-size: 8pt; white-space: nowrap;">जय हिंद - जय भारत - जय गौ माता</div>
                            </div>
                            <div class="h-footer">Together We Serve • Go Raksha Dal Haryana</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="btn-print-wrap">
                <button class="btn-print" onclick="tysPrintNew('${frontId}', '${backId}')"><i class="fa-solid fa-print"></i> प्रिंट आईडी कार्ड</button>
            </div>
        `;

        setTimeout(() => {
            JsBarcode(`#bar-${safeId}`, fullID, { format: "CODE128", displayValue: false, height: 40, width: 1.4, margin: 0, background: "transparent" });
            // Render OLD QR (Reduced Size)
            new QRCode(document.getElementById(`qr-old-${safeId}`), { text: qrText, width: 75, height: 75, correctLevel: QRCode.CorrectLevel.M });
            // Render NEW QR
            new QRCode(document.getElementById(`qr-new-${safeId}`), { text: newQrText, width: 75, height: 75, correctLevel: QRCode.CorrectLevel.M });
        }, 100);
    }

    // === PRINT LOGIC (UPDATED TO FIX BLANK QR CODES) ===
    function tysPrintNew(fid, bid) {
        // --- HELPER TO CONVERT SVG/CANVAS TO IMAGE DATA ---
        function nodeToDataURL(element) {
            const serializer = new XMLSerializer();
            const str = serializer.serializeToString(element);
            return "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(str)));
        }

        // --- 1. PREPARE FRONT (Barcode Fix) ---
        const frontClone = document.getElementById(fid).cloneNode(true);
        const barcodeSvg = frontClone.querySelector('svg');
        
        if (barcodeSvg) {
            const img = document.createElement('img');
            img.src = nodeToDataURL(barcodeSvg);
            img.style.width = "100%";
            img.style.height = "100%";
            img.style.display = "block";
            barcodeSvg.parentNode.replaceChild(img, barcodeSvg);
        }
        const frontHTML = frontClone.outerHTML;

        // --- 2. PREPARE BACK (QR Fix - Manual extraction) ---
        // CLONE DOES NOT COPY CANVAS DATA, SO WE MUST READ FROM ORIGINAL SOURCE
        const originalBack = document.getElementById(bid);
        const backClone = originalBack.cloneNode(true);
        
        // Find both QR containers in the Original and the Clone
        const origQrDivs = originalBack.querySelectorAll('.vb-qr-small');
        const cloneQrDivs = backClone.querySelectorAll('.vb-qr-small');

        // Iterate through original containers to extract image data
        origQrDivs.forEach((origDiv, index) => {
            const origCanvas = origDiv.querySelector('canvas');
            const origImg = origDiv.querySelector('img');
            let imgSrc = null;

            if (origCanvas) {
                // If it's a canvas, convert to PNG data URL
                imgSrc = origCanvas.toDataURL("image/png");
            } else if (origImg) {
                // If it's already an image (some browsers), use src
                imgSrc = origImg.src;
            }

            // Insert image into clone if data exists
            if (imgSrc && cloneQrDivs[index]) {
                const targetDiv = cloneQrDivs[index];
                targetDiv.innerHTML = ''; // Clear clone artifacts
                const newImg = document.createElement('img');
                newImg.src = imgSrc;
                newImg.style.width = '100%';
                newImg.style.height = '100%';
                newImg.style.display = 'block';
                targetDiv.appendChild(newImg);
            }
        });

        const backHTML = backClone.outerHTML;

        // --- 3. GENERATE PRINT WINDOW ---
        const win = window.open('', '_blank', 'width=900,height=800');
        
        win.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Print ID Card</title>
                <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700;800&family=Rozha+One&display=swap" rel="stylesheet">
                <style>
                    @page { size: A4; margin: 10mm; }
                    html, body { margin: 0; padding: 20px; background: #fff; font-family: 'Noto Sans Devanagari', sans-serif; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    
                    .print-container { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10mm; }
                    .cut-wrapper { border: 1px dashed #999; padding: 1px; display: inline-block; }

                    /* REPLICATING THE CSS HERE FOR PRINT VIEW */
                    .id-card-inner { 
                        width: 96mm; height: 65mm;
                        background: white; position: relative; overflow: hidden; 
                        border: 1px solid #aaa; border-radius: 0; 
                        display: flex; flex-direction: column; line-height: normal;
                    }

                    .h-header { height: 16mm; background: #002347; display: flex; align-items: center; justify-content: space-between; padding: 0 2mm; position: relative; z-index: 5; border-bottom: 1.8mm solid #d62d20; }
                    .h-logo, .h-cow { width: 14.5mm; height: 14.5mm; object-fit: contain; } 
                    .h-cow { border-radius: 50%; border: 1px solid white; object-fit: cover; }
                    .h-titles { flex: 1; text-align: center; padding-top: 3.5mm; }
                    .h-main-title { font-family: 'Rozha One', serif; font-size: 13.5pt; color: white; line-height: 0.9; margin:0; white-space: nowrap; }
                    .h-sub-title { font-size: 6pt; font-weight: 700; color: #ffeb3b; line-height: 1.2; margin-top: 0.5mm; }
                    .h-tag { position: absolute; top: 0; left: 50%; transform: translateX(-50%); font-size: 4pt; background: #d62d20; color: white; padding: 1px 8px; border-radius: 0; text-transform: uppercase; font-weight: 800; z-index:10; }
                    
                    .h-body { flex: 1; display: flex; flex-direction: column; padding: 2mm 3mm; position: relative; background: rgba(255,255,255,0.94); }
                    
                    .bg-wm { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); width: 30mm; opacity: 0.08; z-index: 0; }
                    
                    .h-content-row { display: flex; width: 100%; flex: 1; }
                    .h-left { width: 25mm; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
                    .h-p-box { width: 22mm; height: 30mm; background: #fff; position: relative; border: 1.5px solid #002347; border-radius: 0; overflow: hidden; }
                    .h-p-img { width: 100%; height: 100%; object-fit: cover; }
                    .h-stamp { position: absolute; bottom: 0; right: 0; width: 14mm; opacity: 0.9; mix-blend-mode: multiply; transform: rotate(-15deg); z-index: 10; display: none !important; }
                    
                    .h-sign-box { width: 100%; text-align: center; margin-top: 1mm; flex-shrink: 0; }
                    .h-sign-img { height: 7mm; width: auto; max-width: 100%; display: block; margin: 0 auto; mix-blend-mode: multiply; }
                    .h-sign-lbl { font-size: 4pt; color: #002347; font-weight: 700; border-top: 0.5px solid #000; padding-top: 0.5px; display: block; width: 100%; }
                    
                    .h-right { flex: 1; padding-left: 5mm; display: flex; flex-direction: column; position: relative; }
                    .h-row-id { font-size: 10pt; font-weight: 800; color: #d62d20; border-bottom: 1px dashed #002347; margin-bottom: 1.5mm; padding-bottom: 0.5mm; display: block; width: 100%; text-align: center; }
                    
                    .h-grid { display: grid; grid-template-columns: 20mm 1fr; row-gap: 1.5mm; font-size: 7.5pt; }
                    .hl { color: #002347; font-weight: 800; } .hv { color: #000; font-weight: 700; white-space: nowrap; overflow: hidden; }
                    
                    .h-barcode-row { width: 100%; height: 11mm; display: flex; justify-content: center; align-items: center; margin-top: 1mm; border-top: 0.5px dotted #ccc; }
                    .h-bar-wrap { width: 95%; height: 100%; display:flex; justify-content:center; } 
                    .h-bar-wrap svg, .h-bar-wrap img { width:100%; height:100%; object-fit: contain; }
                    
                    .h-footer { height: 5mm; background: #002347; color: white; display: flex; align-items: center; justify-content: center; font-size: 4pt; font-weight: 600; text-align: center; line-height: 1.1; border-top: 1px solid #d62d20; white-space: nowrap; }
                    
                    .h-header-back-title { margin-top: 2mm; color: white; font-family: 'Noto Sans Devanagari'; font-size: 12pt; font-weight: 700; }
                    .vb-c { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 2mm 3mm 6mm 3mm; text-align: center; }
                    
                    /* NEW PRINT STYLES FOR DUAL QR */
                    .vb-qr-row { display: flex; justify-content: center; align-items: center; gap: 3mm; margin-bottom: 2mm; width: 100%; }
                    .vb-qr-small { width: 22mm; height: 22mm; border: 1.5px solid #002347; padding: 1px; border-radius: 0; } 
                    .vb-qr-small img { width: 100%; height: 100%; }
                    
                    .vb-t { font-size: 9pt; font-weight: 800; color: #002347; margin-bottom: 1mm; text-transform: uppercase; }
                    .vb-s { font-size: 6.5pt; color: #444; width: 85%; font-weight: 600; line-height: 1.3; }
                    .vb-contact { margin-bottom: 2mm; font-size: 5pt; color: #002347; font-weight: 800; border-bottom: 1px dashed #d62d20; padding-bottom: 1px; width: 95%; white-space: nowrap; overflow: hidden; }
                </style>
            </head>
            <body>
                <div class="print-container">
                    <div class="cut-wrapper">${frontHTML}</div>
                    <div class="cut-wrapper">${backHTML}</div>
                </div>
            </body>
            </html>
        `);
        win.document.close();
        
        win.onload = function() {
            setTimeout(() => {
                win.focus();
                win.print();
            }, 1000);
        };
    }
</script>
